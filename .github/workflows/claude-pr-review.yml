name: Claude PR Review

on:
  # PRä½œæˆæ™‚ãƒ»æ›´æ–°æ™‚ã«è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

  # PRã‚„Issueã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã§@claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒã‚ã£ãŸå ´åˆã«å®Ÿè¡Œ
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write  # OIDCèªè¨¼ã«å¿…è¦
  actions: read    # CIçµæœã®åˆ†æã«å¿…è¦

jobs:
  # PRè‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆPRä½œæˆãƒ»æ›´æ–°æ™‚ï¼‰
  auto-review:
    if: |
      github.event_name == 'pull_request' &&
      !github.event.pull_request.draft
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦diffã‚’æ­£ç¢ºã«åˆ†æ

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}  # æ˜ç¤ºçš„ã«GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒ‡å®š
          track_progress: true  # é€²æ—çŠ¶æ³ã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’æœ‰åŠ¹åŒ–
          prompt: |
            ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            PRç•ªå·: #${{ github.event.pull_request.number }}
            PRã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.pull_request.title }}
            PRã®èª¬æ˜: ${{ github.event.pull_request.body }}
            ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.event.pull_request.base.ref }}
            ãƒ˜ãƒƒãƒ‰ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.event.pull_request.head.ref }}

            ## é‡è¦ãªæŒ‡ç¤º
            ã“ã®PRã‚’è©³ç´°ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’GitHubã®PRã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚
            å¿…ãš`gh pr comment`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’PRã«æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚
            ç‰¹å®šã®ã‚³ãƒ¼ãƒ‰è¡Œã«é–¢ã™ã‚‹æŒ‡æ‘˜ãŒã‚ã‚‹å ´åˆã¯ã€`mcp__github_inline_comment__create_inline_comment`ã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

            æ³¨æ„: GitHubã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ã‚’æŠ•ç¨¿ã—ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦é€ä¿¡ã—ãªã„ã§ãã ã•ã„ã€‚

            ## ãƒ¬ãƒ“ãƒ¥ãƒ¼æ–¹é‡
            ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰ã€ã“ã®PRã‚’è©³ç´°ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„:

            ### 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼
            - SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSã€CSRFç­‰ã®è„†å¼±æ€§
            - èªè¨¼ãƒ»èªå¯ã®å•é¡Œ
            - æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©ï¼ˆAPIã‚­ãƒ¼ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç­‰ï¼‰
            - ä¾å­˜é–¢ä¿‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯

            ### 2. ã‚³ãƒ¼ãƒ‰å“è³ªãƒ¬ãƒ“ãƒ¥ãƒ¼
            - ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã¨ä¿å®ˆæ€§
            - è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã®é©åˆ‡ãªä½¿ç”¨
            - é‡è¤‡ã‚³ãƒ¼ãƒ‰ã®æœ‰ç„¡
            - å‘½åè¦å‰‡ã®ä¸€è²«æ€§
            - é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

            ### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒ“ãƒ¥ãƒ¼
            - N+1å•é¡Œç­‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–
            - ä¸å¿…è¦ãªãƒ«ãƒ¼ãƒ—ã‚„è¨ˆç®—ã®æœ‰ç„¡
            - ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®å¯èƒ½æ€§
            - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®é©åˆ‡ãªä½¿ç”¨

            ### 4. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
            - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã¸ã®æº–æ‹ 
            - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç¢ºèª
            - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°å¿…è¦æ€§
            - å‹å®‰å…¨æ€§ã®ç¢ºä¿ï¼ˆTypeScript/å‹ãƒ’ãƒ³ãƒˆç­‰ï¼‰

            ### 5. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
            - è¦ä»¶ã¨ã®æ•´åˆæ€§
            - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®è€ƒæ…®
            - ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§

            ## å‡ºåŠ›å½¢å¼ï¼ˆgh pr commentã§æŠ•ç¨¿ã™ã‚‹å†…å®¹ï¼‰
            ä»¥ä¸‹ã®å½¢å¼ã§PRã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

            # ğŸ¤– Claude Code è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

            ## ç·åˆè©•ä¾¡
            æ‰¿èªå¯èƒ½ / ä¿®æ­£å¿…è¦ / è¦è­°è«–

            ## ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒãƒªãƒ¼
            [å…¨ä½“çš„ãªæ‰€æ„Ÿã‚’2-3è¡Œã§è¨˜è¼‰]

            ## é‡è¦åº¦åˆ¥ã®æŒ‡æ‘˜äº‹é …

            ### ğŸš¨ Criticalï¼ˆå¿…ãšä¿®æ­£ãŒå¿…è¦ï¼‰
            - [å…·ä½“çš„ãªå•é¡Œç‚¹ã¨ä¿®æ­£æ–¹æ³•]

            ### âš ï¸ Warningï¼ˆä¿®æ­£ã‚’å¼·ãæ¨å¥¨ï¼‰
            - [å…·ä½“çš„ãªå•é¡Œç‚¹ã¨ä¿®æ­£ææ¡ˆ]

            ### ğŸ’¡ Suggestionï¼ˆæ”¹å–„ææ¡ˆï¼‰
            - [æ”¹å–„ã§ãã‚‹ç‚¹ã¨å…·ä½“ä¾‹]

            ### âœ… Goodï¼ˆè‰¯ã„å®Ÿè£…ï¼‰
            - [è©•ä¾¡ã§ãã‚‹ç‚¹]

            ## è©³ç´°ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            å¿…è¦ã«å¿œã˜ã¦ã€å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚„ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’å«ã‚ã‚‹

            ---
            > ğŸ’¡ **ãƒ’ãƒ³ãƒˆ**: ã‚ˆã‚Šè©³ç´°ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ãªå ´åˆã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆã§ `@claude` ã‚’ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„ã€‚

            ultrathink

          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --model claude-4-0-sonnet-20250805
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Read,GlobTool,GrepTool"

  # @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã¸ã®å¿œç­”
  mention-response:
    if: |
      github.event_name == 'issue_comment' &&
      (contains(github.event.comment.body, '@claude') ||
       contains(github.event.comment.body, '@Claude'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Respond to Claude mention
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}  # æ˜ç¤ºçš„ã«GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒ‡å®š
          track_progress: true  # é€²æ—çŠ¶æ³ã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’æœ‰åŠ¹åŒ–
          prompt: |
            ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆè€…: @${{ github.event.comment.user.login }}
            ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹: ${{ github.event.comment.body }}

            ## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            ${{ github.event.issue.pull_request && 'ã“ã‚Œã¯PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã™ã€‚' || 'ã“ã‚Œã¯Issueã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã™ã€‚' }}
            ${{ github.event.issue.pull_request && format('PRç•ªå·: #{0}', github.event.issue.number) || format('Issueç•ªå·: #{0}', github.event.issue.number) }}
            ã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.issue.title }}

            ## é‡è¦ãªæŒ‡ç¤º
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã¦é©åˆ‡ã«å¿œç­”ã—ã€ãã®å¿œç­”ã‚’`gh issue comment`ã¾ãŸã¯`gh pr comment`ã‚’ä½¿ç”¨ã—ã¦GitHubã«æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚
            GitHubã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ã‚’æŠ•ç¨¿ã—ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦é€ä¿¡ã—ãªã„ã§ãã ã•ã„ã€‚

            ## å¿œç­”æ–¹é‡
            1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç†è§£ã—ã€é©åˆ‡ã«å¿œç­”ã—ã¦ãã ã•ã„
            2. ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒæ±‚ã‚ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€è©³ç´°ãªåˆ†æã‚’æä¾›ã—ã¦ãã ã•ã„
            3. è³ªå•ã«ã¯å…·ä½“çš„ã‹ã¤å»ºè¨­çš„ã«å›ç­”ã—ã¦ãã ã•ã„
            4. å¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’æä¾›ã—ã¦ãã ã•ã„
            5. ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã‹ã¤ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒˆãƒ¼ãƒ³ã‚’ä¿ã£ã¦ãã ã•ã„

            ## å‡ºåŠ›å½¢å¼
            ä»¥ä¸‹ã®å½¢å¼ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

            ## ğŸ¤– Claude ã‹ã‚‰ã®å¿œç­”

            @{{ github.event.comment.user.login }} ã•ã‚“ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚

            [ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ¡ãƒ³ãƒˆã«å¯¾ã™ã‚‹å…·ä½“çš„ãªå¿œç­”å†…å®¹]

            ---
            > ğŸ’¡ è¿½åŠ ã®è³ªå•ãŒã‚ã‚‹å ´åˆã¯ã€ãŠæ°—è»½ã« `@claude` ã‚’ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„ã€‚

            ultrathink

          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --model claude-4-0-sonnet-20250805
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh issue comment:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Read,GlobTool,GrepTool"

  # ãƒ¬ãƒ“ãƒ¥ãƒ¼å¤±æ•—æ™‚ã®é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  notify-failure:
    if: failure()
    needs: [auto-review, mention-response]
    runs-on: ubuntu-latest
    steps:
      - name: Post failure comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // contextã¯github-scriptãŒè‡ªå‹•çš„ã«æä¾›ã™ã‚‹ãŸã‚ã€å®£è¨€ä¸è¦
            const issue_number = context.payload.pull_request?.number || context.payload.issue?.number;

            if (issue_number) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: 'âš ï¸ Claude Codeã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
              });
            }