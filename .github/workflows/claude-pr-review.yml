name: Claude PR Review

on:
  # PRä½œæˆæ™‚ãƒ»æ›´æ–°æ™‚ã«è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

  # PRã‚„Issueã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã§@claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒã‚ã£ãŸå ´åˆã«å®Ÿè¡Œ
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write  # OIDCèªè¨¼ã«å¿…è¦
  actions: read    # CIçµæœã®åˆ†æã«å¿…è¦

jobs:
  # PRè‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆPRä½œæˆãƒ»æ›´æ–°æ™‚ï¼‰
  auto-review:
    if: |
      github.event_name == 'pull_request' &&
      !github.event.pull_request.draft
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦diffã‚’æ­£ç¢ºã«åˆ†æ

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            # PRè‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ - Ultrathink

            ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            PRç•ªå·: #${{ github.event.pull_request.number }}
            PRã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.pull_request.title }}
            PRã®èª¬æ˜: ${{ github.event.pull_request.body }}
            ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.event.pull_request.base.ref }}
            ãƒ˜ãƒƒãƒ‰ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.event.pull_request.head.ref }}

            ## ãƒ¬ãƒ“ãƒ¥ãƒ¼æ–¹é‡
            ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰ã€ã“ã®PRã‚’è©³ç´°ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„:

            ### 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼
            - SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSã€CSRFç­‰ã®è„†å¼±æ€§
            - èªè¨¼ãƒ»èªå¯ã®å•é¡Œ
            - æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©ï¼ˆAPIã‚­ãƒ¼ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç­‰ï¼‰
            - ä¾å­˜é–¢ä¿‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯

            ### 2. ã‚³ãƒ¼ãƒ‰å“è³ªãƒ¬ãƒ“ãƒ¥ãƒ¼
            - ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã¨ä¿å®ˆæ€§
            - è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã®é©åˆ‡ãªä½¿ç”¨
            - é‡è¤‡ã‚³ãƒ¼ãƒ‰ã®æœ‰ç„¡
            - å‘½åè¦å‰‡ã®ä¸€è²«æ€§
            - é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

            ### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒ“ãƒ¥ãƒ¼
            - N+1å•é¡Œç­‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–
            - ä¸å¿…è¦ãªãƒ«ãƒ¼ãƒ—ã‚„è¨ˆç®—ã®æœ‰ç„¡
            - ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®å¯èƒ½æ€§
            - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®é©åˆ‡ãªä½¿ç”¨

            ### 4. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
            - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã¸ã®æº–æ‹ 
            - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç¢ºèª
            - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°å¿…è¦æ€§
            - å‹å®‰å…¨æ€§ã®ç¢ºä¿ï¼ˆTypeScript/å‹ãƒ’ãƒ³ãƒˆç­‰ï¼‰

            ### 5. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
            - è¦ä»¶ã¨ã®æ•´åˆæ€§
            - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®è€ƒæ…®
            - ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§

            ## å‡ºåŠ›å½¢å¼
            1. **ç·åˆè©•ä¾¡**: æ‰¿èªå¯èƒ½/ä¿®æ­£å¿…è¦/è¦è­°è«–
            2. **é‡è¦åº¦åˆ¥ã®æŒ‡æ‘˜äº‹é …**:
               - ğŸš¨ **Critical**: å¿…ãšä¿®æ­£ãŒå¿…è¦ãªå•é¡Œ
               - âš ï¸ **Warning**: ä¿®æ­£ã‚’å¼·ãæ¨å¥¨ã™ã‚‹å•é¡Œ
               - ğŸ’¡ **Suggestion**: æ”¹å–„ææ¡ˆ
               - âœ… **Good**: è‰¯ã„å®Ÿè£…ã¨ã—ã¦è©•ä¾¡ã§ãã‚‹ç‚¹
            3. **å…·ä½“çš„ãªä¿®æ­£ææ¡ˆ**: å¯èƒ½ãªé™ã‚Šã‚³ãƒ¼ãƒ‰ä¾‹ã‚’å«ã‚ã‚‹

            ultrathink

          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --model claude-4-0-sonnet-20250805
            --allowedTools Edit,Read,Write,Bash,GlobTool,GrepTool

  # @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã¸ã®å¿œç­”
  mention-response:
    if: |
      github.event_name == 'issue_comment' &&
      (contains(github.event.comment.body, '@claude') ||
       contains(github.event.comment.body, '@Claude'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Respond to Claude mention
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            # ã‚³ãƒ¡ãƒ³ãƒˆã¸ã®å¿œç­”

            ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆè€…: @${{ github.event.comment.user.login }}
            ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹: ${{ github.event.comment.body }}

            ## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            ${{ github.event.issue.pull_request && 'ã“ã‚Œã¯PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã™ã€‚' || 'ã“ã‚Œã¯Issueã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã™ã€‚' }}

            ${{ github.event.issue.pull_request && format('PRç•ªå·: #{0}', github.event.issue.number) || format('Issueç•ªå·: #{0}', github.event.issue.number) }}
            ã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.issue.title }}

            ## å¿œç­”æ–¹é‡
            1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç†è§£ã—ã€é©åˆ‡ã«å¿œç­”ã—ã¦ãã ã•ã„
            2. ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒæ±‚ã‚ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€è©³ç´°ãªåˆ†æã‚’æä¾›ã—ã¦ãã ã•ã„
            3. è³ªå•ã«ã¯å…·ä½“çš„ã‹ã¤å»ºè¨­çš„ã«å›ç­”ã—ã¦ãã ã•ã„
            4. å¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’æä¾›ã—ã¦ãã ã•ã„
            5. ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã‹ã¤ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒˆãƒ¼ãƒ³ã‚’ä¿ã£ã¦ãã ã•ã„

            ultrathink

          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --model claude-4-0-sonnet-20250805
            --allowedTools Edit,Read,Write,Bash,GlobTool,GrepTool

  # ãƒ¬ãƒ“ãƒ¥ãƒ¼å¤±æ•—æ™‚ã®é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  notify-failure:
    if: failure()
    needs: [auto-review, mention-response]
    runs-on: ubuntu-latest
    steps:
      - name: Post failure comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const context = github.context;
            const issue_number = context.payload.pull_request?.number || context.payload.issue?.number;

            if (issue_number) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: 'âš ï¸ Claude Codeã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
              });
            }